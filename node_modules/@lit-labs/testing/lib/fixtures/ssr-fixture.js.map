{"version":3,"file":"ssr-fixture.js","sourceRoot":"","sources":["../../src/lib/fixtures/ssr-fixture.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * @license\n * Copyright 2022 Google LLC\n * SPDX-License-Identifier: BSD-3-Clause\n */\n\nimport {executeServerCommand} from '@web/test-runner-commands';\nimport {hydrateShadowRoots} from '@webcomponents/template-shadowroot';\nimport {hydrate as hydrateFunc} from '@lit-labs/ssr-client';\nimport {createContainer} from './fixture-wrapper.js';\nimport {litSsrPluginCommand} from '../constants.js';\nimport {nextFrame} from '../utils.js';\n\nimport type {LitElement, TemplateResult} from 'lit';\nimport type {FixtureOptions, SsrFixtureOptions} from './fixture-options.js';\nimport type {Payload} from '../lit-ssr-plugin.js';\n\n// Enhance `Element` with method that parses declarative shadow DOM\n// See https://github.com/whatwg/html/pull/9538\ndeclare global {\n  interface Element {\n    setHTMLUnsafe(html: string): void;\n  }\n}\n\n/**\n * Renders the provided Lit template server-side by executing a custom command\n * for Web Test Runner provided by the Lit SSR Plugin, loads it to the document\n * and (optionally) hydrates it, returning the element.\n *\n * This module **must** be imported before any custom element definitions.\n */\nexport async function ssrFixture<T extends HTMLElement>(\n  template: TemplateResult,\n  {modules, base, hydrate = true}: SsrFixtureOptions\n): Promise<T> {\n  if (base === undefined) {\n    // Find the test file url from the call stack\n    // Chrome:\n    // Error\n    // at ssrFixture (http://localhost:8000/node_modules/@lit-labs/testing/lib/fixtures/ssrFixture.js:29:17)\n    // at ssrHydratedFixture (http://localhost:8000/node_modules/@lit-labs/testing/lib/fixtures/ssrFixture.js:76:12)\n    // at o.<anonymous> (http://localhost:8000/test/my-element_test.js?wtr-session-id=GhB4vW1TXWxXwqgt3F8QD:65:30)\n    //\n    // Firefox:\n    // ssrFixture@http://localhost:8000/node_modules/@lit-labs/testing/lib/fixtures/ssrFixture.js:29:17\n    // ssrHydratedFixture@http://localhost:8000/node_modules/@lit-labs/testing/lib/fixtures/ssrFixture.js:76:12\n    // @http://localhost:8000/test/my-element_test.js?wtr-session-id=NaCljZAFiyeOoV6-qBqwr:65:30\n    //\n    // Webkit:\n    // @http://localhost:8000/node_modules/@lit-labs/testing/lib/fixtures/ssrFixture.js:29:26\n    // asyncFunctionResume@[native code]\n    // asyncFunctionResume@[native code]\n    // @http://localhost:8000/test/my-element_test.js?wtr-session-id=aKWON-wBOBGyzb2CwIvmK:65:37\n    const {stack} = new Error();\n    const match = stack?.match(/http:\\/\\/localhost.+(?=\\?wtr-session-id)/);\n    if (!match) {\n      throw new Error(\n        `Could not find call site for ssrFixture in stack:\\n${stack}`\n      );\n    }\n    base = match[0];\n  }\n\n  const rendered = await executeServerCommand<string, Payload>(\n    litSsrPluginCommand,\n    {\n      template,\n      modules: modules.map((module) => new URL(module, base).pathname),\n    }\n  );\n\n  const container = createContainer();\n\n  if (\n    HTMLTemplateElement.prototype.hasOwnProperty('shadowRootMode') &&\n    'setHTMLUnsafe' in Element.prototype\n  ) {\n    // Browser natively supports Declarative Shadow DOM and `setHTMLUnsafe()`\n    // which is needed for DSD to be parsed and attached.\n    container.setHTMLUnsafe(rendered);\n  } else {\n    // Utilize ponyfill\n    container.innerHTML = rendered;\n    hydrateShadowRoots(container);\n  }\n\n  const el = container.firstElementChild;\n  if (hydrate) {\n    if (el?.hasAttribute('defer-hydration')) {\n      el.removeAttribute('defer-hydration');\n      await (el as unknown as LitElement).updateComplete;\n    } else {\n      hydrateFunc(template, container);\n      const litEl = container.querySelector('[defer-hydration]');\n      if (litEl) {\n        litEl.removeAttribute('defer-hydration');\n        await (litEl as LitElement).updateComplete;\n      } else {\n        await nextFrame();\n      }\n    }\n  }\n  return el as T;\n}\n\n/**\n * Renders the provided Lit template server-side by executing a custom command\n * for Web Test Runner provided by the Lit SSR Plugin, loads it to the document\n * and hydrates it, returning the element.\n *\n * This module **must** be imported before any custom element definitions.\n */\nexport async function ssrHydratedFixture<T extends HTMLElement>(\n  template: TemplateResult,\n  {modules, base}: FixtureOptions\n) {\n  return ssrFixture<T>(template, {modules, base, hydrate: true});\n}\n\n/**\n * Renders the provided Lit template server-side by executing a custom command\n * for Web Test Runner provided by the Lit SSR Plugin, loads it to the document\n * **without** hydrating it, returning the element.\n *\n * This module **must** be imported before any custom element definitions.\n */\nexport async function ssrNonHydratedFixture<T extends HTMLElement>(\n  template: TemplateResult,\n  {modules, base}: FixtureOptions\n) {\n  return ssrFixture<T>(template, {modules, base, hydrate: false});\n}\n"]}